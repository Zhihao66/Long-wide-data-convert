/**
 * æ•°æ®æ ¼å¼è½¬æ¢å·¥å…· - æ ¸å¿ƒé€»è¾‘
 * Data Format Converter - Core Logic
 */

// ==================== å›½é™…åŒ– (i18n) ====================

let currentLanguage = localStorage.getItem('dataConverterLang') || 'cn';

const i18n = {
    cn: {
        title: 'æ•°æ®æ ¼å¼è½¬æ¢å·¥å…·',
        subtitle: 'Wide & Long Format Data Converter',
        input: 'ðŸ“¥ è¾“å…¥æ•°æ®',
        output: 'ðŸ“¤ è¾“å‡ºç»“æžœ',
        text: 'æ–‡æœ¬',
        file: 'æ–‡ä»¶',
        pasteData: 'ç²˜è´´ä½ çš„ CSV æˆ– TSV æ•°æ®',
        uploadPlaceholder: 'ðŸ“ ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ–‡ä»¶\nä»…æ”¯æŒ CSV (.csv) æˆ– TSV (.tsv)',
        conversionMode: 'è½¬æ¢æ–¹å‘',
        wide2long: 'å®½ â†’ é•¿ (Wide to Long)',
        long2wide: 'é•¿ â†’ å®½ (Long to Wide)',
        idColumns: 'ID åˆ—ï¼ˆä¿æŒä¸å˜ï¼‰',
        varName: 'å˜é‡åˆ—å',
        valueName: 'å€¼åˆ—å',
        indexCol: 'ç´¢å¼•åˆ—',
        columnCol: 'åˆ—åˆ—',
        valueCol: 'å€¼åˆ—',
        convert: 'ðŸ”„ å¼€å§‹è½¬æ¢',
        clear: 'ðŸ—‘ï¸ æ¸…ç©º',
        copy: 'ðŸ“‹ å¤åˆ¶',
        download: 'â¬‡ï¸ ä¸‹è½½',
        success: 'è½¬æ¢æˆåŠŸï¼',
        error: 'è½¬æ¢å¤±è´¥',
        errorParse: 'æ— æ³•è§£æžæ•°æ®ï¼Œè¯·ç¡®ä¿ä¸º CSV æˆ– TSV æ–‡æœ¬',
        errorIdVars: 'è¯·è¾“å…¥ ID åˆ—',
        errorRequired: 'è¯·å¡«å†™æ‰€æœ‰å¿…éœ€çš„åˆ—å‚æ•°',
        errorFileType: 'ä»…æ”¯æŒ CSV (.csv) æˆ– TSV (.tsv) æ–‡ä»¶',
        errorNoInput: 'è¯·è¾“å…¥æ•°æ®',
        errorNoCopy: 'æ²¡æœ‰å¯å¤åˆ¶çš„æ•°æ®',
        errorNoDownload: 'æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®',
        copiedMessage: 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼',
        downloadedMessage: 'æ–‡ä»¶å·²ä¸‹è½½ï¼',
        about: 'å…³äºŽ',
        examples: 'ðŸ“š ä½¿ç”¨ç¤ºä¾‹',
        example1: 'ç¤ºä¾‹ 1: å­¦ç”Ÿæˆç»©',
        example2: 'ç¤ºä¾‹ 2: é”€å”®æ•°æ®',
        example3: 'ç¤ºä¾‹ 3: é•¿ â†’ å®½',
        inputWide: 'è¾“å…¥ï¼ˆå®½æ ¼å¼ï¼‰ï¼š',
        outputLong: 'è¾“å‡ºï¼ˆé•¿æ ¼å¼ï¼‰ï¼š',
        inputLong: 'è¾“å…¥ï¼ˆé•¿æ ¼å¼ï¼‰ï¼š',
        outputWide: 'è¾“å‡ºï¼ˆå®½æ ¼å¼ï¼‰ï¼š',
        about_text: 'æ•°æ®æ ¼å¼è½¬æ¢å·¥å…· v1.0\n\nè¿™æ˜¯ä¸€ä¸ªåœ¨çº¿æ•°æ®è½¬æ¢å·¥å…·ï¼Œæ”¯æŒï¼š\nâ€¢ å®½æ ¼å¼è½¬é•¿æ ¼å¼\nâ€¢ é•¿æ ¼å¼è½¬å®½æ ¼å¼\nâ€¢ CSV / TSV æ–‡æœ¬å¯¼å…¥/å¯¼å‡º\n\nMade with â¤ï¸ for data analysis\nMIT License',
        wideDesc: 'å¤šåˆ—æ”¾ä¸åŒå˜é‡ï¼Œä¸€è¡Œä¸€ä¸ªè§‚æµ‹',
        longDesc: 'å¤šè¡Œæ”¾åŒä¸ªè§‚æµ‹ï¼Œä¸€åˆ—ä¸€ä¸ªå˜é‡',
        biDesc: 'æ”¯æŒå®½ â†” é•¿ç›¸äº’è½¬æ¢',
        fileFormatDesc: 'ä»…æ”¯æŒ CSVã€TSVï¼ˆæ–‡æœ¬åˆ†éš”ï¼‰'
    },
    en: {
        title: 'Data Format Converter',
        subtitle: 'Wide & Long Format Data Converter',
        input: 'ðŸ“¥ Input Data',
        output: 'ðŸ“¤ Output',
        text: 'Text',
        file: 'File',
        pasteData: 'Paste your CSV or TSV data',
        uploadPlaceholder: 'ðŸ“ Click to select or drag files\nSupports CSV (.csv) or TSV (.tsv) only',
        conversionMode: 'Conversion Mode',
        wide2long: 'Wide â†’ Long (Wide to Long)',
        long2wide: 'Long â†’ Wide (Long to Wide)',
        idColumns: 'ID Columns (Keep)',
        varName: 'Variable Column Name',
        valueName: 'Value Column Name',
        indexCol: 'Index Column',
        columnCol: 'Column Column',
        valueCol: 'Value Column',
        convert: 'ðŸ”„ Convert',
        clear: 'ðŸ—‘ï¸ Clear',
        copy: 'ðŸ“‹ Copy',
        download: 'â¬‡ï¸ Download',
        success: 'Conversion successful!',
        error: 'Conversion failed',
        errorParse: 'Failed to parse data. Ensure data is in CSV or TSV format.',
        errorIdVars: 'Please enter ID columns',
        errorRequired: 'Please fill all required column parameters',
        errorFileType: 'Only CSV (.csv) or TSV (.tsv) files are supported',
        errorNoInput: 'Please enter data',
        errorNoCopy: 'No data to copy',
        errorNoDownload: 'No data to download',
        copiedMessage: 'Copied to clipboard!',
        downloadedMessage: 'File downloaded!',
        about: 'About',
        examples: 'ðŸ“š Examples',
        example1: 'Example 1: Student Grades',
        example2: 'Example 2: Sales Data',
        example3: 'Example 3: Long â†’ Wide',
        inputWide: 'Input (Wide Format):',
        outputLong: 'Output (Long Format):',
        inputLong: 'Input (Long Format):',
        outputWide: 'Output (Wide Format):',
        about_text: 'Data Format Converter v1.0\n\nOnline tool supporting:\nâ€¢ Wide to Long format conversion\nâ€¢ Long to Wide format conversion\nâ€¢ CSV / TSV text import/export\n\nMade with â¤ï¸ for data analysis\nMIT License',
        wideDesc: 'Different variables in columns, one observation per row',
        longDesc: 'One observation per variable, multiple rows per observation',
        biDesc: 'Supports bidirectional Wide â†” Long conversion',
        fileFormatDesc: 'CSV, TSV (tab-separated values) only'
    }
};

function t(key) {
    return i18n[currentLanguage][key] || key;
}

function setLanguage(lang) {
    if (['cn', 'en'].includes(lang)) {
        currentLanguage = lang;
        localStorage.setItem('dataConverterLang', lang);
        location.reload();
    }
}

// ==================== è¾…åŠ©å‡½æ•° ====================

// è®°å½•æœ€åŽä¸€æ¬¡æ£€æµ‹åˆ°çš„åˆ†éš”ç¬¦ï¼ˆç”¨äºŽä¸‹è½½åŽç¼€ç­‰ï¼‰
let lastDetectedDelimiter = ',';

/**
 * CSV å­—ç¬¦ä¸²è½¬ JSON æ•°ç»„
 */
function csvToArray(csvString) {
    let normalized = csvString.replace(/\\t/g, '\t');
    const rawLines = normalized.trim().split(/\r?\n/);
    if (!rawLines || rawLines.length === 0) return { headers: [], data: [], delimiter: ',' };

    const firstLine = rawLines[0];
    const commaCount = (firstLine.match(/,/g) || []).length;
    const tabCount = (firstLine.match(/\t/g) || []).length;
    const delimiter = tabCount >= commaCount && tabCount > 0 ? '\t' : ',';

    lastDetectedDelimiter = delimiter;
    try {
        console.debug('[parser] detected delimiter:', JSON.stringify(delimiter));
        console.debug('[parser] raw header line:', rawLines[0]);
    } catch (e) {}

    let headers = parseCSVLine(rawLines[0], delimiter);
    if (headers.length === 1 && headers[0] && headers[0].includes(delimiter)) {
        headers = headers[0].split(delimiter).map(h => h.trim());
    }
    const data = [];
    for (let i = 1; i < rawLines.length; i++) {
        if (rawLines[i].trim() === '') continue;
        let values = parseCSVLine(rawLines[i], delimiter);
        if (values.length === 1 && values[0].includes(delimiter)) {
            values = values[0].split(delimiter).map(v => v.trim());
        }
        const obj = {};
        for (let j = 0; j < headers.length; j++) {
            obj[headers[j]] = values[j] || '';
        }
        data.push(obj);
    }

    return { headers, data, delimiter };
}

/**
 * è§£æž CSV è¡Œ
 */
function parseCSVLine(line, delimiter = ',') {
    const result = [];
    let current = '';
    let insideQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];

        if (char === '"') {
            if (insideQuotes && nextChar === '"') {
                current += '"';
                i++;
            } else {
                insideQuotes = !insideQuotes;
            }
        } else if (char === delimiter && !insideQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }

    result.push(current.trim());
    return result;
}

/**
 * JSON æ•°ç»„è½¬ CSV
 */
function arrayToCSV(headers, data, delimiter = ',') {
    const lines = [];
    lines.push(headers.map(h => escapeCSV(h, delimiter)).join(delimiter === '\t' ? '\t' : ','));
    for (const row of data) {
        const values = headers.map(h => escapeCSV(String(row[h] || ''), delimiter));
        lines.push(values.join(delimiter === '\t' ? '\t' : ','));
    }
    return lines.join('\n');
}

/**
 * è½¬ä¹‰ CSV å€¼
 */
function escapeCSV(value, delimiter = ',') {
    return escapeCSVWithDelimiter(value, delimiter);
}

function escapeCSVWithDelimiter(value, delimiter) {
    const needsQuote = value.includes('"') || value.includes('\n') || (delimiter === ',' ? value.includes(',') : value.includes('\t'));
    if (needsQuote) {
        return '"' + value.replace(/"/g, '""') + '"';
    }
    return value;
}

// ==================== è½¬æ¢é€»è¾‘ ====================

/**
 * å®½æ ¼å¼è½¬é•¿æ ¼å¼
 */
function wideToLong(data, idVars, valueVars = null, varName = 'variable', valueName = 'value') {
    const idVarsArray = typeof idVars === 'string' 
        ? idVars.split(',').map(v => v.trim()) 
        : idVars;

    const allColumns = Object.keys(data[0] || {});
    let valueVarsArray = valueVars;
    
    if (!valueVars) {
        valueVarsArray = allColumns.filter(col => !idVarsArray.includes(col));
    } else {
        valueVarsArray = typeof valueVars === 'string' 
            ? valueVars.split(',').map(v => v.trim()) 
            : valueVars;
    }

    const result = [];

    for (const row of data) {
        for (const varCol of valueVarsArray) {
            const newRow = {};
            for (const idCol of idVarsArray) {
                newRow[idCol] = row[idCol];
            }
            newRow[varName] = varCol;
            newRow[valueName] = row[varCol];
            result.push(newRow);
        }
    }

    return result;
}

/**
 * é•¿æ ¼å¼è½¬å®½æ ¼å¼
 */
function longToWide(data, indexCols, columnCol, valueCol) {
    const indexColsArray = typeof indexCols === 'string' 
        ? indexCols.split(',').map(v => v.trim()) 
        : indexCols;

    const result = {};
    const columnValues = new Set();

    for (const row of data) {
        const colValue = String(row[columnCol]);
        columnValues.add(colValue);
    }

    for (const row of data) {
        const indexKey = indexColsArray.map(col => String(row[col])).join('|||');
        
        if (!result[indexKey]) {
            result[indexKey] = {};
            for (const col of indexColsArray) {
                result[indexKey][col] = row[col];
            }
            for (const colValue of columnValues) {
                result[indexKey][colValue] = '';
            }
        }
        
        const colValue = String(row[columnCol]);
        result[indexKey][colValue] = row[valueCol];
    }

    return Object.values(result);
}

// ==================== UI äº¤äº’ ====================

function switchInputMode(mode) {
    const textInput = document.getElementById('textInput');
    const fileInput = document.getElementById('fileInput');
    const buttons = document.querySelectorAll('.toggle-btn');
    
    buttons.forEach((btn, idx) => {
        if ((idx === 0 && mode === 'text') || (idx === 1 && mode === 'file')) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    if (mode === 'text') {
        textInput.style.display = 'block';
        fileInput.style.display = 'none';
    } else {
        textInput.style.display = 'none';
        fileInput.style.display = 'block';
    }
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const name = file.name || '';
    const lower = name.toLowerCase();
    if (!(lower.endsWith('.csv') || lower.endsWith('.tsv'))) {
        showError(t('errorFileType'));
        event.target.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const content = e.target.result;
        document.getElementById('dataInput').value = content;
    };
    reader.readAsText(file);
}

document.addEventListener('DOMContentLoaded', function() {
    const modeSelect = document.getElementById('conversionMode');
    if (modeSelect) {
        modeSelect.addEventListener('change', function() {
            const wide2longOptions = document.getElementById('wide2longOptions');
            const long2wideOptions = document.getElementById('long2wideOptions');
            
            if (this.value === 'wide2long') {
                wide2longOptions.style.display = 'block';
                long2wideOptions.style.display = 'none';
            } else {
                wide2longOptions.style.display = 'none';
                long2wideOptions.style.display = 'block';
            }
        });
    }
});

function convertData() {
    try {
        const input = document.getElementById('dataInput').value.trim();
        if (!input) {
            showError(t('errorNoInput'));
            return;
        }
        const parsed = csvToArray(input);
        if (!parsed || !parsed.data || parsed.data.length === 0) {
            showError(t('errorParse'));
            return;
        }

        const data = parsed.data;
        const headers = parsed.headers || Object.keys(data[0]);
        const mode = document.getElementById('conversionMode').value;

        let resultData;

        if (mode === 'wide2long') {
            const idVars = document.getElementById('idVars').value;
            if (!idVars) {
                showError(t('errorIdVars'));
                return;
            }

            const varName = document.getElementById('varName').value || 'variable';
            const valueName = document.getElementById('valueName').value || 'value';

            resultData = wideToLong(data, idVars, null, varName, valueName);
        } else {
            const indexCols = document.getElementById('indexCol').value;
            const columnCol = document.getElementById('columnCol').value;
            const valueCol = document.getElementById('valueCol').value;

            if (!indexCols || !columnCol || !valueCol) {
                showError(t('errorRequired'));
                return;
            }

            resultData = longToWide(data, indexCols, columnCol, valueCol);
        }

        const resultHeaders = Object.keys(resultData[0] || {});
        const outDelimiter = (parsed && parsed.delimiter) ? parsed.delimiter : lastDetectedDelimiter;
        const resultCSV = arrayToCSV(resultHeaders, resultData, outDelimiter);

        document.getElementById('dataOutput').value = resultCSV;
        showSuccess(t('success'));
    } catch (error) {
        showError(t('error') + ': ' + error.message);
        console.error(error);
    }
}

function copyOutput() {
    const output = document.getElementById('dataOutput');
    if (!output.value) {
        showError(t('errorNoCopy'));
        return;
    }

    output.select();
    document.execCommand('copy');
    showSuccess(t('copiedMessage'));
}

function downloadOutput() {
    const output = document.getElementById('dataOutput').value;
    if (!output) {
        showError(t('errorNoDownload'));
        return;
    }

    const isTSV = lastDetectedDelimiter === '\t';
    const mime = isTSV ? 'text/tab-separated-values;charset=utf-8;' : 'text/csv;charset=utf-8;';
    const ext = isTSV ? 'tsv' : 'csv';

    const blob = new Blob([output], { type: mime });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `data_${new Date().getTime()}.${ext}`;
    link.click();
    showSuccess(t('downloadedMessage'));
}

function clearInput() {
    document.getElementById('dataInput').value = '';
    document.getElementById('idVars').value = '';
    document.getElementById('indexCol').value = '';
    document.getElementById('columnCol').value = '';
    document.getElementById('valueCol').value = '';
}

function clearOutput() {
    document.getElementById('dataOutput').value = '';
}

function showSuccess(msg) {
    const element = document.getElementById('successMessage');
    element.textContent = 'âœ“ ' + msg;
    element.style.display = 'block';
    setTimeout(() => {
        element.style.display = 'none';
    }, 3000);
}

function showError(msg) {
    const element = document.getElementById('errorMessage');
    element.textContent = 'âœ— ' + msg;
    element.style.display = 'block';
    setTimeout(() => {
        element.style.display = 'none';
    }, 3000);
}

function showExample(index) {
    const tabs = document.querySelectorAll('.example-tab');
    const contents = document.querySelectorAll('.example-content');

    tabs.forEach((tab, i) => {
        if (i === index) {
            tab.classList.add('active');
            contents[i].classList.add('active');
        } else {
            tab.classList.remove('active');
            contents[i].classList.remove('active');
        }
    });
}

function showAbout() {
    alert(t('about_text'));
}

document.addEventListener('DOMContentLoaded', function() {
    const defaultExample = `id,name,Math,English,Science
1,Alice,85,92,88
2,Bob,90,88,92`;
    
    document.getElementById('dataInput').placeholder = t('pasteData') + '...\n\nä¾‹å¦‚:\n' + defaultExample;
});
